/*
 * The MIT License (MIT)
 *
 * Copyright (c) 2014-2015 Bastian Engelmann
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
package eu.verdelhan.ta4j.indicators.trackers;

import eu.verdelhan.ta4j.Decimal;
import eu.verdelhan.ta4j.Indicator;
import static eu.verdelhan.ta4j.TATestsUtils.assertDecimalEquals;
import eu.verdelhan.ta4j.TimeSeries;
import eu.verdelhan.ta4j.indicators.simple.ClosePriceIndicator;
import eu.verdelhan.ta4j.mocks.MockTimeSeries;
import org.junit.After;
import org.junit.AfterClass;
import org.junit.Before;
import org.junit.BeforeClass;
import org.junit.Test;
import static org.junit.Assert.*;

/**
 *
 * @author Bastian Engelmann
 */
public class TrailingStopLossIndicatorTest {
    
    private TimeSeries data;
    
    public TrailingStopLossIndicatorTest() {
    }
    
    @BeforeClass
    public static void setUpClass() {
    }
    
    @AfterClass
    public static void tearDownClass() {
    }
    
    @Before
    public void setUp() {
        
        data = new MockTimeSeries(
                        40.854999999999996873611962655559,
                        40.591999999999998749444785062224,
                        40.917999999999999261035554809496,
                        40.997999999999997555732988985255,
                        40.993000000000002103206497849897,
                        41.183999999999997498889570124447,
                        40.796999999999997044142219237983,
                        41.159999999999996589394868351519,
                        41.118999999999999772626324556768,
                        41.091000000000001080024958355352,
                        41.188000000000002387423592153937,
                        41.338000000000000966338120633736,
                        41.749000000000002330580173293129,
                        41.643999999999998351540853036568,
                        41.353999999999999204192135948688,
                        41.965000000000003410605131648481,
                        41.121999999999999886313162278384,
                        41.207000000000000738964445190504,
                        41.832999999999998408384271897376,
                        41.890000000000000568434188608080,
                        41.642000000000003012701199622825,
                        41.810999999999999943156581139192,
                        41.878000000000000113686837721616,
                        41.945000000000000284217094304040,
                        42.222999999999998976818460505456,
                        42.201000000000000511590769747272,
                        41.963000000000000966338120633736,
                        42.159999999999996589394868351519,
                        42.235999999999997100985638098791,
                        42.228000000000001534772309241816,
                        42.136000000000002785327524179593,
                        42.274000000000000909494701772928,
                        42.317000000000000170530256582424,
                        42.496999999999999886313162278384,
                        41.920000000000001705302565824240,
                        42.159999999999996589394868351519,
                        41.869999999999997442046151263639,
                        42.075000000000002842170943040401,
                        41.976999999999996759925124933943,
                        42.095999999999996532551449490711,
                        42.396999999999998465227690758184,
                        42.424999999999997157829056959599,
                        41.676000000000001932676241267473,
                        41.134999999999998010480339871719,
                        41.255000000000002557953848736361,
                        41.085000000000000852651282912120,
                        41.570999999999997953636921010911,
                        41.954000000000000625277607468888,
                        41.710000000000000852651282912120,
                        41.338000000000000966338120633736,
                        41.185999999999999943156581139192,
                        40.787999999999996703081706073135,
                        40.618999999999999772626324556768,
                        40.798999999999999488409230252728,
                        40.639000000000002899014361901209,
                        41.344999999999998863131622783840,
                        41.606999999999999317878973670304,
                        41.613999999999997214672475820407,
                        41.914999999999999147348717087880,
                        41.905999999999998806288203923032,
                        41.792000000000001591615728102624,
                        42.131999999999997896793502150103,
                        42.737999999999999545252649113536,
                        42.664999999999999147348717087880,
                        42.838999999999998635757947340608,
                        43.145000000000003126388037344441,
                        43.246999999999999886313162278384,
                        43.247999999999997555732988985255,
                        43.189999999999997726263245567679,
                        43.511000000000002785327524179593,
                        43.667000000000001591615728102624,
                        43.920000000000001705302565824240,
                        43.773000000000003240074875066057,
                        43.719000000000001193711796076968,
                        44.146000000000000795807864051312,
                        43.723999999999996646238287212327,
                        43.093000000000003524291969370097,
                        43.103999999999999204192135948688,
                        43.262999999999998124167177593336,
                        43.539000000000001477928890381008,
                        43.076000000000000511590769747272,
                        42.975000000000001421085471520200,
                        42.898000000000003240074875066057,
                        42.976999999999996759925124933943,
                        42.100000000000001421085471520200,
                        42.201000000000000511590769747272,
                        42.493000000000002103206497849897,
                        42.280999999999998806288203923032,
                        41.756000000000000227373675443232,
                        41.777999999999998692601366201416,
                        42.149999999999998578914528479800,
                        42.130000000000002557953848736361,
                        42.064999999999997726263245567679,
                        41.712000000000003296918293926865,
                        41.192999999999997839950083289295,
                        40.790999999999996816768543794751,
                        40.317999999999997839950083289295,
                        40.637000000000000454747350886464,
                        41.231999999999999317878973670304,
                        41.649000000000000909494701772928,
                        41.707999999999998408384271897376,
                        41.354999999999996873611962655559,
                        41.478999999999999204192135948688,
                        42.095999999999996532551449490711,
                        42.104999999999996873611962655559,
                        42.396000000000000795807864051312,
                        42.837000000000003296918293926865,
                        42.932999999999999829469743417576,
                        42.987000000000001875832822406664,
                        42.973999999999996646238287212327,
                        43.478000000000001534772309241816,
                        43.475999999999999090505298227072,
                        43.405999999999998806288203923032,
                        43.347999999999998976818460505456,
                        43.046999999999997044142219237983,
                        43.021999999999998465227690758184,
                        43.716999999999998749444785062224,
                        44.009000000000000341060513164848,
                        44.149999999999998578914528479800,
                        44.054999999999999715782905695960,
                        44.508000000000002671640686457977,
                        44.655999999999998806288203923032,
                        44.593000000000003524291969370097,
                        44.606000000000001648459146963432,
                        44.648000000000003240074875066057,
                        44.628000000000000113686837721616,
                        44.387000000000000454747350886464,
                        44.201999999999998181010596454144,
                        44.383000000000002671640686457977,
                        44.793999999999996930455381516367,
                        44.701999999999998181010596454144,
                        43.990000000000001989519660128281,
                        43.935000000000002273736754432321,
                        43.969000000000001193711796076968,
                        43.929000000000002046363078989089,
                        44.218000000000003524291969370097,
                        44.240999999999999658939486835152,
                        44.445000000000000284217094304040,
                        44.979999999999996873611962655559,
                        44.5,
                        45.137000000000000454747350886464,
                        45.520000000000003126388037344441,
                        45.442999999999997839950083289295,
                        45.183999999999997498889570124447,
                        45.646000000000000795807864051312,
                        45.420999999999999374722392531112,
                        45.420999999999999374722392531112,
                        45.856000000000001648459146963432,
                        45.613999999999997214672475820407,
                        45.402999999999998692601366201416,
                        45.393999999999998351540853036568,
                        45.246000000000002216893335571513,
                        45.512999999999998124167177593336,
                        45.348999999999996646238287212327,
                        44.978999999999999204192135948688,
                        45.371999999999999886313162278384,
                        45.198000000000000397903932025656,
                        45.253999999999997783106664428487,
                        44.753000000000000113686837721616,
                        44.674999999999997157829056959599,
                        44.476999999999996759925124933943,
                        44.835000000000000852651282912120,
                        45.040999999999996816768543794751,
                        45.029000000000003467448550509289,
                        44.957999999999998408384271897376,
                        44.908999999999998919975041644648,
                        44.807999999999999829469743417576,
                        45.296999999999997044142219237983,
                        45.738999999999997214672475820407,
                        45.792000000000001591615728102624,
                        45.332000000000000738964445190504,
                        45.304000000000002046363078989089,
                        45.314999999999997726263245567679,
                        45.287999999999996703081706073135,
                        45.218000000000003524291969370097,
                        45.076999999999998181010596454144,
                        45.226999999999996759925124933943,
                        45.222000000000001307398633798584,
                        44.853000000000001534772309241816,
                        45.201999999999998181010596454144,
                        45.423999999999999488409230252728,
                        44.871000000000002216893335571513,
                        45.006999999999997896793502150103,
                        45.070999999999997953636921010911,
                        45.090000000000003410605131648481,
                        45.085000000000000852651282912120,
                        45.127000000000002444267011014745,
                        44.817000000000000170530256582424,
                        45.095999999999996532551449490711,
                        45.229999999999996873611962655559,
                        45.234000000000001762145984685048,
                        45.387999999999998124167177593336,
                        45.686999999999997612576407846063,
                        45.564000000000000056843418860808,
                        45.454000000000000625277607468888,
                        45.381999999999997896793502150103,
                        44.207000000000000738964445190504,
                        44.176999999999999602096067974344,
                        44.585000000000000852651282912120,
                        44.896999999999998465227690758184,
                        44.914999999999999147348717087880,
                        44.460000000000000852651282912120,
                        44.110999999999997100985638098791,
                        43.953000000000002955857780762017,
                        44.222999999999998976818460505456,
                        44.243000000000002103206497849897,
                        44.204000000000000625277607468888,
                        44.508000000000002671640686457977,
                        44.790999999999996816768543794751,
                        45.148000000000003240074875066057,
                        45.633000000000002671640686457977,
                        45.902999999999998692601366201416,
                        45.743000000000002103206497849897,
                        45.609000000000001762145984685048,
                        45.999000000000002330580173293129,
                        46.073999999999998067323758732527,
                        46.439999999999997726263245567679,
                        46.777000000000001023181539494544,
                        46.331000000000003069544618483633,
                        46.637999999999998124167177593336,
                        46.628000000000000113686837721616,
                        46.837000000000003296918293926865,
                        46.935000000000002273736754432321,
                        46.893999999999998351540853036568,
                        46.841999999999998749444785062224,
                        46.963999999999998635757947340608,
                        47.152999999999998692601366201416,
                        46.853999999999999204192135948688,
                        46.067000000000000170530256582424,
                        45.310999999999999943156581139192,
                        45.659999999999996589394868351519,
                        45.817000000000000170530256582424,
                        45.237999999999999545252649113536,
                        44.960000000000000852651282912120);
        
    }
    
    @After
    public void tearDown() {
    }

    /**
     * Test of of class TrailingStopLossIndicator.
     */

    @Test
    public void TestNoInitialLimitUsingClosePrice() {
        Decimal distance = Decimal.valueOf(0.69161372459053893635427812114358);
        Indicator<Decimal>  price = new ClosePriceIndicator(data); 
        TrailingStopLossIndicator tsl_indicator = new TrailingStopLossIndicator(price,distance);

        assertEquals(tsl_indicator.getValue(0), price.getValue(0).minus(distance));
        
        assertDecimalEquals(tsl_indicator.getValue(2), Double.parseDouble("40.226386275409460324681276688352"));
        assertDecimalEquals(tsl_indicator.getValue(3), Double.parseDouble("40.306386275409458619378710864112"));
        assertDecimalEquals(tsl_indicator.getValue(4), Double.parseDouble("40.306386275409458619378710864112"));
        assertDecimalEquals(tsl_indicator.getValue(5), Double.parseDouble("40.492386275409458562535292003303"));
        assertDecimalEquals(tsl_indicator.getValue(10), Double.parseDouble("40.496386275409463451069314032793"));
        assertDecimalEquals(tsl_indicator.getValue(11), Double.parseDouble("40.646386275409462029983842512592"));
        
    }
    
    @Test
    public void TestUsingInitialLimitUsingClosePrice() {
        Decimal distance = Decimal.valueOf(0.69161372459053893635427812114358);
        Indicator<Decimal>  price = new ClosePriceIndicator(data); 
        TrailingStopLossIndicator tsl_indicator = new TrailingStopLossIndicator(price,distance,Decimal.valueOf(42.425));
        
        assertDecimalEquals(tsl_indicator.getValue(0), 42.425);
        assertDecimalEquals(tsl_indicator.getValue(64), 42.425);
        assertDecimalEquals(tsl_indicator.getValue(65), Double.parseDouble("42.453386275409464190033759223297"));
        assertDecimalEquals(tsl_indicator.getValue(66), Double.parseDouble("42.555386275409460949958884157240"));
        assertDecimalEquals(tsl_indicator.getValue(67), Double.parseDouble("42.556386275409458619378710864111"));
        assertDecimalEquals(tsl_indicator.getValue(69), Double.parseDouble("42.819386275409463848973246058449"));
    }
    
}
